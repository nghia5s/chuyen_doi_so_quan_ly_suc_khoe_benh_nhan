<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Dashboard | Hospital Portal</title>
  <!-- 1. LINK CSS C·ª¶A BOOTSTRAP -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- 2. CSS T√ôY CH·ªàNH C·ª¶A B·∫†N (ƒêANG ·ªû ƒê√ÇY) -->
  <style>
    body {
      /* B·∫°n c√≥ th·ªÉ th√™m URL ·∫£nh n·ªÅn v√†o ƒë√¢y */
      background: url('') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Poppins', sans-serif;
      background-color: #f4f7f6; /* M√†u n·ªÅn d·ª± ph√≤ng */
    }
    .navbar {
      background-color: #007bff !important;
    }
    .navbar-brand, .nav-link {
      color: white !important;
    }
    .table th {
      background-color: #007bff;
      color: white;
    }
    .card {
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border: none;
        border-radius: 10px;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">üè• B√°c Sƒ© S·ªë</a>
      <div class="ms-auto">
        <a href="{{ url_for('logout') }}" class="btn btn-light">Logout</a>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <h3 class="text-primary mb-3">Your Appointments</h3>

    <!-- Hi·ªÉn th·ªã th√¥ng b√°o (flash messages) n·∫øu c√≥ -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('book') }}" enctype="multipart/data" class="card p-3 mb-4">
      <h5>Book New Appointment</h5>
      <div class="row">
        <div class="col-md-4 mb-2">
          <input type="text" name="disease" class="form-control" placeholder="Disease / Concern" required>
        </div>
        <div class="col-md-3 mb-2">
          <!-- C·∫¨P NH·∫¨T: Th√™m id v√† min (l·∫•y t·ª´ Flask) -->
          <input type="date" name="date" id="date-input" class="form-control" 
                 min="{{ today_date }}" required>
        </div>
        <div class="col-md-3 mb-2">
          <!-- C·∫¨P NH·∫¨T: Th√™m id -->
          <input type="time" name="time" id="time-input" class="form-control" required>
        </div>
        <div class="col-md-2 mb-2">
          <input type="file" name="image" class="form-control">
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Book</button>
    </form>

    <table class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>Disease</th>
          <th>Date & Time</th>
          <th>Status</th>
          <th>Image</th>
        </tr>
      </thead>
      <tbody>
        <!-- C·∫¨P NH·∫¨T: S·ª≠a l·∫°i ch·ªâ s·ªë (index) c·ªßa v√≤ng l·∫∑p cho ƒë√∫ng c·ªôt -->
        <!-- Query: SELECT disease[0], datetime[1], status[2], image_path[3], id[4] -->
        {% for a in appointments %}
        <tr>
          <td>{{ a[0] }}</td> <!-- Disease -->
          <td>{{ a[1] }}</td> <!-- Date & Time -->
          <td>
            <!-- C·∫≠p nh·∫≠t logic m√†u badge -->
            {% if a[2] == 'approved' %}
              <span class="badge bg-success">Approved</span>
            {% elif a[2] == 'rejected' %}
              <span class="badge bg-danger">Rejected</span>
            {% else %}
              <span class="badge bg-secondary">Pending</span>
            {% endif %}
          </td>
          <td>
            <!-- S·ª≠a l·∫°i logic l·∫•y t√™n file (ƒë√£ l∆∞u filename trong DB) -->
            {% if a[3] %}
              <a href="{{ url_for('uploaded_file', filename=a[3]) }}" target="_blank">View</a>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Th√™m th∆∞ vi·ªán JS c·ªßa Bootstrap (ƒë·ªÉ alert ho·∫°t ƒë·ªông) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- C·∫¨P NH·∫¨T: Th√™m JavaScript ƒë·ªÉ x·ª≠ l√Ω logic th·ªùi gian -->
  <script>
    // Ch·∫°y code khi trang ƒë√£ t·∫£i xong
    document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.getElementById('date-input');
        const timeInput = document.getElementById('time-input');
        
        // L·∫•y ng√†y gi·ªù hi·ªán t·∫°i (ƒë∆∞·ª£c truy·ªÅn t·ª´ server Flask)
        const today_date = "{{ today_date }}";
        const current_time = "{{ current_time }}";

        function updateMinTime() {
            const selectedDate = dateInput.value;
            
            // N·∫øu user ch·ªçn ng√†y h√¥m nay
            if (selectedDate === today_date) {
                // Th√¨ gi·ªù b·∫Øt ƒë·∫ßu ph·∫£i l√† gi·ªù hi·ªán t·∫°i
                timeInput.min = current_time;
            } else {
                // N·∫øu user ch·ªçn ng√†y t∆∞∆°ng lai, th√¨ gi·ªù n√†o c≈©ng ƒë∆∞·ª£c (x√≥a min)
                timeInput.min = null;
            }
        }

        // G·ªçi h√†m n√†y m·ªói khi user thay ƒë·ªïi ng√†y
        dateInput.addEventListener('change', updateMinTime);
        
        // G·ªçi h√†m n√†y khi t·∫£i trang (ƒë·ªÉ √°p d·ª•ng n·∫øu ng√†y m·∫∑c ƒë·ªãnh l√† h√¥m nay)
        updateMinTime();
    });
  </script>
</body>
</html>